<html>
  <head>
    <meta charset="UTF-8" />
    <title>Code Challenge</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.11.8/semantic.min.css"
    />
    <link rel="stylesheet" href="assets/index.css" />
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  </head>
  <body>
    <!-- navbar -->
    <div class="heading">
      <div class="item">
        <h2 class="ui header">
          <i class="orange ticket icon"></i>
          <div class="content">FLATDANGO</div>
          <div class="sub header" id="subtitle">BUY MOVIE TICKETS</div>
        </h2>
      </div>
    </div>

    <div class="ui centered grid">
      <div class="four wide column">
        <div class="list-container">
          <!-- side menu -->
          <ul class="ui divided list" id="films">
            <li class="film item">Movie titles will go here.</li>
          </ul>
        </div>
      </div>

      <!-- poster -->
      <div class="four wide column">
        <img
          id="poster"
          src="assets/placeholderImage.png"
          alt="[MOVIE TITLE]"
        />
      </div>

      <!-- showing info -->
      <div class="four wide column">
        <div class="ui cards" id="showing">
          <div class="card">
            <div id="title" class="title">[MOVIE TITLE]</div>
            <div id="runtime" class="meta">[RUNTIME] minutes</div>
            <div class="content">
              <div class="description">
                <div id="film-info">[INSERT MOVIE DESCRIPTION HERE]</div>
                <span id="showtime" class="ui label">[SHOWTIME]</span>
                <span id="ticket-num">[X]</span> remaining tickets
              </div>
            </div>
            <div class="extra content">
              <button id="buy-ticket" class="ui orange button">
                Buy Ticket
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const filmList = document.getElementById("films");
        const poster = document.getElementById("poster");
        const title = document.getElementById("title");
        const runtime = document.getElementById("runtime");
        const filmInfo = document.getElementById("film-info");
        const showtime = document.getElementById("showtime");
        const ticketNum = document.getElementById("ticket-num");
        const buyTicketButton = document.getElementById("buy-ticket");
      
        
        const fetchFilms = async () => {
          const response = await fetch("http://localhost:3000/films");
          const films = await response.json();
          renderFilmList(films);
          if (films.length > 0) {
            renderFilmDetails(films[0]); 
          }
        };
      
       
        const renderFilmList = (films) => {
          filmList.innerHTML = "";
          films.forEach(film => {
            const li = document.createElement("li");
            li.className = "film item";
            li.textContent = film.title;
            li.dataset.id = film.id;
            li.addEventListener("click", () => {
              renderFilmDetails(film);
            });
            
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.className = "ui red button";
            deleteButton.addEventListener("click", (e) => {
              e.stopPropagation();
              deleteFilm(film.id);
            });
            li.appendChild(deleteButton);
            filmList.appendChild(li);
          });
        };
      
       
        const renderFilmDetails = (film) => {
          poster.src = film.poster;
          title.textContent = film.title;
          runtime.textContent = `${film.runtime} minutes`;
          filmInfo.textContent = film.description;
          showtime.textContent = film.showtime;
      
          const availableTickets = film.capacity - film.tickets_sold;
          ticketNum.textContent = availableTickets;
      
          if (availableTickets > 0) {
            buyTicketButton.disabled = false;
            buyTicketButton.textContent = "Buy Ticket";
          } else {
            buyTicketButton.disabled = true;
            buyTicketButton.textContent = "Sold Out";
          }
      
          buyTicketButton.onclick = () => buyTicket(film);
        };
      
        
        const buyTicket = async (film) => {
          if (film.tickets_sold < film.capacity) {
            const updatedTicketsSold = film.tickets_sold + 1;
      
            await fetch(`http://localhost:3000/films/${film.id}`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ tickets_sold: updatedTicketsSold })
            });
      
           
            await fetch("http://localhost:3000/tickets", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                film_id: film.id,
                number_of_tickets: 1
              })
            });
      
           
            renderFilmDetails({ ...film, tickets_sold: updatedTicketsSold });
          }
        };
      
       
        const deleteFilm = async (filmId) => {
          await fetch(`http://localhost:3000/films/${filmId}`, {
            method: "DELETE"
          });
          fetchFilms(); 
        };
      
      
        fetchFilms();
      });
      
    </script>
  </body>
</html>
